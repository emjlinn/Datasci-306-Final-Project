---
title: "DATASCI 306, Fall 2025, Final Group Project"
author: "Group <28>: Anthony Nguyen, Emily Lin, Eva Naberhaus, Margaret Wozniak, Sreyashi Mondal"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(scales)

```

Throughout this course, you've dedicated yourself to refining your analytical abilities using R programming language. These skills are highly coveted in today's job market!

Now, for the semester project, you'll apply your learning to craft a compelling `Data Story` that can enrich your portfolio and impress prospective employers. Collaborating with a team (up to 5 members of your choosing), you'll construct a Data Story using the data provided in the `data` folder.
This data is downloaded from: https://data.cdc.gov/browse?sortBy=relevance&pageSize=20&q=Adult+Tobacco+Consumption+In+The+U.S.%2C+2000-Present&page=1

## Deliverable

### 1.  Requirement-1 (4 pt)

You should show at least 4 steps you adopt to clean and/or transform the dataset. Some of the steps you might take are; merging all the data into one dataframe, converting datatypes, creating additional columns, cleaning column names etc.
f
### 2. Requirement - 2 (20 pt)

You need to plot 10 different diagrams to show correlations, frequencies, and/or relationships between various variables with plots of 5 different types (bar, line, heatmap, facet, etc.). Every plot should have a title and the x/y axis should have legible labels without any label overlaps for full credit. Provide a summary of your interpretations from the plots after each one. Each chart should be meaningful by itself.

### 3. Requirement - 3 (5 pt)

By this phase, you have a pretty good understanding of your data. Now, you will develop a predictive Machine Learning model to forecast a specified target outcome. For predictor selection, you must apply the feature selection techniques covered in Lectures 19 and 20. Provide a detailed justification for the final set of predictors chosen to receive full credit.

Build an interactive shiny app that allows the user to select or input values and then make predictions using your model. You are required to build the shiny app just for the prediction section of your project. Although we will accept if you create a shiny app for your entire project (not required)

### 4. Requirement - 4 (1 pt)

You should have a conclusion, highlighting the main insights you were able to derive from your analysis. 

This is an open ended project where every team will come up with their own unique insights. We would like to see what each team comes up with.

## Submission

* You will upload the zip file containing your final.Rmd, final.pdf files covering the EDA and app.R file for your shiny app, as a deliverable to Canvas

* You will present your findings by creating a video of a maximum of 15 minutes duration, explaining the code and the workings of your project; all team members should explain their part in the project to receive credit. You will share the video URL on Canvas for credit.

It is not necessary to prepare slides (if you do it doesn't hurt) for the presentation. You may speak by showing the diagrams and/or code from your laptop.  Every team member should explain their part in the project along with the insights they derived by explaining the charts and summaries for full credit to each member. An easy way to get this accomplished is to open a Zoom meeting and everyone take turns in explaining while you record the meeting. Add the URL of this recording to Canvas.

Your project will be evaluated for its meaningful/insightful EDA and predictions.

------------------------------------------------------------------

## Hints

Some answers you may try to find in this dataset could be:

* Are smoking disparities related to income getting worse or better over time?
* Which racial or ethnic group faces the greatest inequality in smoking rates compared to the majority population?
* Do people with frequent mental distress have a much higher smoking disparity than people with disabilities?
* Which 5 focus groups have the highest average disparity over the entire period?

These questions could just get you started but as an analyst you should hone the skills of asking good questions and this project will get you that practice.


## Machine Learning Model Development:

You could build  a regression model to predict the DisparityValue. Features may include, Year, disparity category, specific focus group etc. Extract and plot the feature importance to select the features. 

## Summary

Your summary might answer questions like; 

* What were the most significant trends and predictors of smoking disparity? 
* Which populations should be prioritized for smoking cessation programs? etc.  
You may also include ideas for future analysis and any limitations you came across with the current dataset

```{r}
# =====================================================================
# Requirement 1: Data import, cleaning, and transformation
# =====================================================================

library(tidyverse)

#-----------------------------
# STEP 1: Read and MERGE all 5 datasets into ONE data frame
#-----------------------------

data_dir <- "data"  # change this if your CSVs are somewhere else

file_names <- c(
  "Employment-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv",
  "Income-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv",
  "Age-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv",
  "Race_and_Ethnic_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv",
  "Mental_Health-Related_Disparities_in_Cigarette_Smoking_Among_Adults_20251101.csv"
)

# keep the raw list in case you ever want to look at individual tables
smoking_raw_list <- file_names |>
  set_names() |>
  map(\(fn) read_csv(file.path(data_dir, fn), show_col_types = FALSE))

# one big raw data frame (row-bind all 5 sources)
smoking_raw <- bind_rows(smoking_raw_list)

#-----------------------------
# STEP 2: Convert DATA TYPES to appropriate formats
#-----------------------------

smoking_typed <- smoking_raw |>
  mutate(
    Year = as.integer(Year),
    State = as.factor(State),

    # Clean prevalence columns before numeric conversion
    focus_prev_pct = `Cigarette Use Prevalence % (Focus group)` |>
      str_replace_all("%", "") |>
      str_replace_all("[^0-9\\.]", "") |>      # remove non-numeric characters
      na_if("") |>
      as.numeric(),

    reference_prev_pct = `Cigarette Use Prevalence % (Reference group)` |>
      str_replace_all("%", "") |>
      str_replace_all("[^0-9\\.]", "") |>
      na_if("") |>
      as.numeric(),

    disparity_value = `Disparity Value` |>
      str_replace_all("[^0-9\\.-]", "") |>     # allow negative numbers
      na_if("") |>
      as.numeric()
  )

#-----------------------------
# STEP 3: Create CLEANER COLUMN NAMES / ALIASES
#   (This keeps the original CDC column names AND adds easy ones)
#-----------------------------

smoking_named <- smoking_typed |>
  rename(
    focus_group        = `Comparing (Focus group)`,
    reference_group    = `To (Reference group)`,
    tobacco_use_type   = `Tobacco Use`,
    disparity_category = Demographic
  )

#-----------------------------
# STEP 4: Create ADDITIONAL COLUMNS and HANDLE MISSING VALUES
#-----------------------------

smoking_all <- smoking_named |>
  # drop rows that don't have a disparity value
  filter(!is.na(disparity_value)) |>
  # direction of disparity (is the focus group worse off?)
  mutate(
    disparity_direction = case_when(
      disparity_value > 0 ~ "Focus group worse",
      disparity_value < 0 ~ "Focus group better",
      TRUE                ~ "No difference"
    ),
    disparity_direction = factor(
      disparity_direction,
      levels = c("Focus group worse", "No difference", "Focus group better")
    )
  )

# `smoking_all` is the main cleaned data set
# You still keep `smoking_raw` and `smoking_raw_list` if other code needs them.

```

```{r}
#Find avg cigarette use prevalence according to the reference group
library(scales)

smoking_all |>
  filter(disparity_category == "Age") |>
  group_by(reference_group, Year) |>
  summarize(
    avg_reference_prev = mean(reference_prev_pct, na.rm = TRUE),
    .groups = "drop"
  ) |>
  ggplot(aes(x = Year, y = avg_reference_prev, color = reference_group)) +
  geom_line() +
  scale_x_continuous(breaks = pretty_breaks(n = 5)) +
  labs(
    color = "Age Group",
    y = "Average Cigarette Use Prevalence (%)",
    title = "Cigarette Use Prevalence Percentage Over Time (Reference Groups)"
  )
```

```{r}
smoking_all |>
  filter(disparity_category == "Employment") |>
  group_by(focus_group, reference_group) |>
  summarize(
    avg_disparity_value = mean(disparity_value, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(grouped = paste(focus_group, reference_group, sep = " vs. ")) |>
  ggplot(aes(x = grouped, y = avg_disparity_value)) +
  geom_col(fill = "darkblue", width = 0.7) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 8),
    plot.margin = unit(c(0, 0, 0, 4), "cm")
  ) +
  labs(
    x = "Focus vs. Reference Groups",
    y = "Disparity Value",
    title = "Disparity Values Across Employment Groups"
  )
```

```{r}
## Does employment status have a relationship with cigarette use?
smoking_all |>
  filter(disparity_category == "Employment") |>
  mutate(
    employment_group = case_when(
      focus_group == "Employed or Self" ~ "Employed",
      focus_group == "Unemployed" ~ "Unemployed",
      focus_group %in% c("Homemaker or Student", "Retired") ~
        "Not in labor force (Homemaker / Student / Retired)",
      focus_group == "Unable to work" ~ "Unable to work",
      TRUE ~ NA_character_
    )
  ) |>
  ggplot(aes(x = Year, y = focus_prev_pct, color = employment_group)) +

  # Trend lines to show actual patterns
  geom_smooth(se = FALSE, linewidth = 1.3) +

  # Lighter, smaller points for context
  geom_point(alpha = 0.15, size = 1.2, position = position_jitter(width = 0.2, height = 0)) +

  labs(
    title = "Employment Status and Cigarette Use Over the Years",
    x = "Year",
    y = "Cigarette Use Prevalence (%)",
    color = "Employment Status"
  ) +

  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 18, face = "bold"),
    legend.title = element_text(face = "bold")
  )

## Looking at the graph, it's apparent that being employed or not being in the labor
## force seem to have much lower cigarette use prevalence than compared to being
## unemployed or unable to work. This relationship could be caused by many factors 
## such as stress or even time. It also seems that there is a slight decline overall
## in smoking prevalance as time progresses regardless of employment status.
```

```{r}
# Geographic heatmaps for each disparity category
library(maps)
library(viridis)

# Get U.S. polygon map
us_map <- map_data("state")

# Standardize state names to uniformly lowercase
smoking_all_states <- smoking_all |>
  mutate(State_full = tolower(State))

categories <- c("Employment", "Age", "Race and Ethnicity", 
                "Income", "Mental Health")

# for each category, make map 
for (cat in categories) {
  
  # Summarize average disparity by state for that category
  df_cat <- smoking_all_states |>
    filter(disparity_category == cat) |>
    group_by(State_full) |>
    summarize(
      avg_disparity = mean(disparity_value, na.rm = TRUE),
      .groups = "drop"
    )
  
  # Join with map polygons
  df_map <- us_map |>
    left_join(df_cat, by = c("region" = "State_full"))
  
  # Create heatmap
  p <- ggplot(df_map, aes(long, lat, group = group, fill = avg_disparity)) +
    geom_polygon(color = "white", linewidth = 0.3) +
    coord_fixed(1.3) +
    scale_fill_viridis(
      option = "mako",
      direction = -1,
      na.value = "grey80",
      name = "Avg Disparity"
    ) +
    labs(
      title = paste("Smoking Disparity by State:", cat),
      subtitle = "Average Disparity Value (Focus/Reference)",
      caption = "Higher values = worse disparities for the focus group"
    ) +
    theme_void(base_size = 14) +
    theme(
      plot.title = element_text(face = "bold", size = 18),
      plot.subtitle = element_text(size = 12),
      legend.position = "right"
    )
  
  print(p)
}

# Overall Absolute Disparity Score by State

# Average disparity by state/category
state_cat_abs <- smoking_all_states |>
  group_by(State_full, disparity_category) |>
  summarize(
    avg_abs_disparity = mean(abs(disparity_value), na.rm = TRUE),
    .groups = "drop"
  )

#Average across the 5 categories (overall score)
state_overall <- state_cat_abs |>
  group_by(State_full) |>
  summarize(
    overall_abs_disparity = mean(avg_abs_disparity, na.rm = TRUE),
    .groups = "drop"
  )

# Join with map polygons 
map_overall <- us_map |>
  left_join(state_overall, by = c("region" = "State_full"))

# plot
ggplot(map_overall, aes(long, lat, group = group, fill = overall_abs_disparity)) +
  geom_polygon(color = "white", linewidth = 0.3) +
  coord_fixed(1.3) +
  scale_fill_viridis(
    option = "mako",
    direction = -1,
    name = "Overall\nAbsolute\nDisparity",
    na.value = "grey85"
  ) +
  labs(
    title = "Overall Absolute Smoking Disparity by State",
    subtitle = "Average of Absolute Disparities Across All Five Categories",
    caption = "Higher values indicate larger overall inequalities"
  ) +
  theme_void(base_size = 14) +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 12)
  )


## Summary of Interpretations

## Employment: 
## Looking at the graph generated for the employment category, we immediately notice the outlier of Utah. Utah has a much higher disparity rate than every other state in the country, with an average disparity of roughly 1.8. Additionally, we notice that most states in the south have a lower disparity on average compared to states in other regions of the US. 

## Age:
## The graph for age shows a much more even distribution of disparity throughout the US. However, we do still see some concentration of high disparities on the east side of the country, with Michigan, Maine, and West Virginia showing the highest average disparities of roughly 1.30. Importantly, the range of average disparity for age is smaller than the range for employment, with the range ending where the employment range started. This suggests that there is less of a disparity between age groups than there is between employment groups, meaning someones employment status is more likely to make them a smoker than their age is. 

##Race and Ethnicity:
## The graph for race and ethnicity shows little to no geographic trends for smoking disparity by region. However, the map is generally on the darker side, with the darkest states being Minnesota, South Dakota, Vermont, Maryland, and Oregon.

##Income:
## The graph for income shows little to no geographic trends for smoking disparity by region. The darkest states are Idaho, Vermont, Maine, Montana, and Utah. Importantly, this graph is very similar to the employment graph in terms of where relatively darker states are located, highlighting the correlation between employment status and income. 

##Mental Health:
## The graph for mental health shows little to no geographic trends for smoking disparity by region, but is darker on average. The darkest states are Utah, New Hampshire, Massachusetts, and Connecticut. The color distribution of this graph again aligns with the employment and income graphs, suggesting that there is an intersection between focus groups within the employment, income, and mental health groups. Additionally, the range of these three graphs  suggest that the focus groups in these categories tend to do much worse than the focus groups in other categories. 

##Absolute Smoking Disparity by State:
## This graph shows that for all states, the focus group has a higher cigarette use percentage than the reference group does. This is shown in the range, which is strictly greater than 1. Additionally, this graph shows that Utah and Vermont contain the most disparity, while Alabama, Nevada, and Arizona contain the least. 
```

